name = "alist-landing-worker"
main = "dist/worker.js"
compatibility_date = "2024-01-01"

[observability]
[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
persist = true

# Environment variables (configure these in Cloudflare Dashboard or use secrets)
# [vars]
# TOKEN = "your-hmac-token"
# WORKER_ADDRESS_DOWNLOAD = "https://worker1.example.com,https://worker2.example.com"
# UNDER_ATTACK = "false"
# FAST_REDIRECT = "false"
# TURNSTILE_SITE_KEY = ""
# TURNSTILE_SECRET_KEY = ""
# SIGN_SECRET = ""
# IPV4_ONLY = "false"
# VERIFY_HEADER = ""
# VERIFY_SECRET = ""
# IF_APPEND_ADDITIONAL = "true"           # Append additionalInfo parameters to download URLs
# ALIST_ADDRESS = "https://alist.example.com"  # Fallback AList base URL when appending expiry (ADDRESS/ALIST_BASE_URL also supported)
# MIN_ALLOWED_BANDWIDTH = "10"            # Minimum allowed download bandwidth (Mbps)
# MIN_DURATION_TIME = "1h"                # Minimum expiry duration for generated links (supports h/m/s suffix)
# BLACKLIST_PREFIX = "/private,/admin"
# BLACKLIST_ACTION = "block"
# WHITELIST_PREFIX = "/public,/shared"
# WHITELIST_ACTION = "pass-asis"
# EXCEPT_PREFIX = "/guest,/public"
# EXCEPT_ACTION = "block-except"
#
# # Database Mode for IP Rate Limiting
# # Options: "d1" (Cloudflare D1 Binding), "d1-rest" (Cloudflare D1 REST API), "custom-pg-rest" (Custom PostgreSQL + PostgREST)
# # If not set, rate limiting is completely disabled
# DB_MODE = ""
# IPSUBNET_WINDOWTIME_LIMIT = "100"
# WINDOW_TIME = "24h"
# IPV4_SUFFIX = "/32"
# IPV6_SUFFIX = "/60"
# PG_ERROR_HANDLE = "fail-closed"
# CLEANUP_PERCENTAGE = "1"  # 0-100 inclusive, decimals allowed (e.g., "0.1" = 0.1%)
# BLOCK_TIME = "10m"
#
# # D1 (Cloudflare D1 Binding) Rate Limiting - requires DB_MODE="d1"
# # Note: You must also configure d1_databases binding below
# D1_DATABASE_BINDING = "DB"  # Optional, defaults to "DB"
# D1_TABLE_NAME = "IP_LIMIT_TABLE"  # Optional, defaults to IP_LIMIT_TABLE
#
# # D1 REST API Rate Limiting - requires DB_MODE="d1-rest"
# # Use this mode when you cannot use Workers binding (e.g., external API calls)
# D1_ACCOUNT_ID = "your-cloudflare-account-id"
# D1_DATABASE_ID = "your-d1-database-id"
# D1_API_TOKEN = "your-cloudflare-api-token"
# D1_TABLE_NAME = "IP_LIMIT_TABLE"  # Optional, defaults to IP_LIMIT_TABLE
#
# # Custom PostgreSQL + PostgREST Rate Limiting - requires DB_MODE="custom-pg-rest"
# # Use this mode when you have self-hosted PostgreSQL with PostgREST REST API
# # ⚠️ IMPORTANT: You MUST run init.sql on your PostgreSQL database first!
# #   - Creates IP_LIMIT_TABLE table (without IP_ADDR column)
# #   - Creates upsert_rate_limit() stored procedure (required for atomic operations)
# POSTGREST_URL = "https://your-domain.com/postgrest"  # PostgREST API endpoint (without table name)
# POSTGREST_TABLE_NAME = "IP_LIMIT_TABLE"  # Optional, defaults to IP_LIMIT_TABLE
# # Note: VERIFY_HEADER and VERIFY_SECRET (already defined above) are used for PostgREST authentication

# D1 Database Binding (for DB_MODE="d1")
# Uncomment and configure this section if using D1 binding mode
# [[d1_databases]]
# binding = "DB"  # Must match D1_DATABASE_BINDING env var (or use default "DB")
# database_name = "alist-ratelimit-db"
# database_id = "your-d1-database-id"

# For local development, create a .dev.vars file with:
# TOKEN=your-token
# WORKER_ADDRESS_DOWNLOAD=https://worker.example.com
